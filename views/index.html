<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>My SlipCheck</title>
  <link rel="stylesheet" href="/views/css/shared.css">
  <link rel="stylesheet" href="/views/css/main.css">
  <link rel="stylesheet" href="/views/css/dashboard.css">
  <link rel="stylesheet" href="/views/css/settings.css">
  <link rel="stylesheet" href="/views/css/logs.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">$lipCheck</div>
    <ul>
      <li onclick="navigateTo(event, 'main')">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</li>
      <li onclick="navigateTo(event, 'dashboard')">Dashboard</li>
      <li onclick="navigateTo(event, 'logs')">Logs</li>
      <li onclick="navigateTo(event, 'settings')">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏≠‡∏ó</li>
    </ul>
    <div class="footer">
      <a href="/logout" style="color: white; text-decoration: none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content" id="main-content">
    <h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
  </div>

  <!-- Script -->
  <script>
    // Escape HTML ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    function escapeHTML(str) {
      const div = document.createElement("div");
      div.innerText = str;
      return div.innerHTML;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î
    function showLoading(message = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
      const content = document.getElementById("main-content");
      content.innerHTML = `<p style="text-align:center; font-size:18px; color:#555;">${message}</p>`;
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ HTML
    function loadPage(event, page) {
    if (event) event.preventDefault?.();

    // ‡∏•‡πâ‡∏≤‡∏á active class
    const links = document.querySelectorAll(".sidebar li");
    links.forEach(link => link.classList.remove("active"));

    if (event?.target?.tagName === "LI") {
      event.target.classList.add("active");
    }

    showLoading();

    fetch(`/page/${page}`)
      .then(res => {
        if (!res.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ");
        return res.text();
      })
      .then(html => {
        const container = document.getElementById("main-content");
        container.innerHTML = html;

        // ‡πÇ‡∏´‡∏•‡∏î script ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ innerHTML
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = html;
        const scripts = tempDiv.querySelectorAll("script[src]");

        let loaded = 0;
        if (scripts.length === 0) finalize();

        scripts.forEach(tag => {
          const s = document.createElement("script");
          s.src = tag.src;
          s.onload = () => { loaded++; if (loaded === scripts.length) finalize(); };
          document.body.appendChild(s);
        });

        // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å then/html ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏∏‡∏î scope
        function finalize() {
        if (page === "main" && typeof loadShopsAndRender === "function") {
          loadShopsAndRender();
        }

        if (page === "dashboard" && typeof initDashboard === "function") {
          initDashboard(); // üü¢ ‡πÇ‡∏´‡∏•‡∏î slip + scroll
          setupSSE();      // üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ SSE
        }
      }

      if (page === "logs") {
        const logsContainer = document.getElementById("logs");
        const eventSource = new EventSource("/api/logs");
        const MAX_LOGS = 50; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á

        eventSource.onmessage = (event) => {
          if (event.data) {
            const logEntry = document.createElement("div");
            logEntry.className = "log-entry";
            logEntry.textContent = event.data;
            logsContainer.appendChild(logEntry);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô MAX_LOGS
            while (logsContainer.children.length > MAX_LOGS) {
            logsContainer.firstElementChild.remove();
          }

            logsContainer.scrollTop = logsContainer.scrollHeight;
          }
        };

        eventSource.onerror = () => {
          const errorEntry = document.createElement("div");
          errorEntry.className = "log-entry error";
          errorEntry.textContent = "‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...";
          logsContainer.appendChild(errorEntry);
        };
      }

      function setupSSE() {
        if (window._sseConnected) return;
        const sse = new EventSource("/events");
        sse.onopen = () => console.log("‚úÖ SSE opened");
        sse.onerror = e => console.error("‚ùå SSE error", e);
        sse.onmessage = (e) => {
          try {
            const newSlip = JSON.parse(e.data);
            console.log("üì© New slip:", newSlip);
            window.slipResults = window.slipResults || [];
            window.slipResults.unshift(newSlip);
            const tbody = document.getElementById("slip-results-body");
            if (tbody) {
              tbody.innerHTML = "";
              renderSlipResults(0, window.visibleCount || 100);
            }
          } catch (err) {
            console.error("‚ùå Error parsing SSE:", err);
          }
        };
        window._sseConnected = true;
      }
    })
    .catch(err => {
      document.getElementById("main-content").innerHTML = `<p style="color:red">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</p>`;
    });
}

function navigateTo(e, p) { loadPage(e, p); }
window.addEventListener("DOMContentLoaded", () => loadPage(null, "main"));
</script>
</body>
</html>